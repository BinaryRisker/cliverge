name: Auto Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: write
  pull-requests: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒæ–°ç‰ˆæœ¬
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.version_check.outputs.should_release }}
      new_version: ${{ steps.version_check.outputs.new_version }}
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥æ¯”è¾ƒç‰ˆæœ¬

      - name: Get current version
        id: current_version
        run: |
          VERSION=$(grep '^version = ' crates/cliverge-gui/Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Get latest release version
        id: latest_release
        run: |
          LATEST=$(gh release list --limit 1 --json tagName --jq '.[0].tagName // "v0.0.0"' || echo "v0.0.0")
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest release: $LATEST"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if version changed
        id: version_check
        run: |
          CURRENT="v${{ steps.current_version.outputs.version }}"
          LATEST="${{ steps.latest_release.outputs.latest }}"
          
          echo "Comparing: $CURRENT vs $LATEST"
          
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "new_version=$CURRENT" >> $GITHUB_OUTPUT
            echo "Version changed, will create new release: $CURRENT"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "Version unchanged, skipping release"
          fi

      - name: Generate changelog
        id: changelog
        if: steps.version_check.outputs.should_release == 'true'
        run: |
          LATEST_TAG="${{ steps.latest_release.outputs.latest }}"
          NEW_VERSION="${{ steps.version_check.outputs.new_version }}"
          
          echo "Generating changelog from $LATEST_TAG to HEAD..."
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          {
            echo "## What's Changed in $NEW_VERSION"
            echo ""
            echo "### ğŸš€ Features & Improvements"
            
            # è·å–è‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„æäº¤
            if [ "$LATEST_TAG" = "v0.0.0" ]; then
              # é¦–æ¬¡å‘å¸ƒï¼Œè·å–æ‰€æœ‰æäº¤
              git log --pretty=format:"- %s (%h)" --no-merges HEAD~10..HEAD || git log --pretty=format:"- %s (%h)" --no-merges
            else
              # è·å–è‡ªä¸Šæ¬¡æ ‡ç­¾ä»¥æ¥çš„æäº¤
              git log --pretty=format:"- %s (%h)" --no-merges $LATEST_TAG..HEAD 2>/dev/null || {
                echo "- Initial release of CLIverge"
                echo "- Universal CLI tool management platform with GUI interface"
                echo "- Cross-platform support (Windows, macOS, Linux)"
                echo "- One-click install/uninstall for various CLI tools"
                echo "- Real-time tool status detection"
                echo "- Integrated logging system"
              }
            fi
            
            echo ""
            echo "### ğŸ“¦ Installation"
            echo ""
            echo "**Shell (Linux/macOS):**"
            echo "\`\`\`bash"
            echo "curl -fsSL https://github.com/\${{ github.repository }}/releases/download/$NEW_VERSION/install.sh | sh"
            echo "\`\`\`"
            echo ""
            echo "**PowerShell (Windows):**"
            echo "\`\`\`powershell"
            echo "irm https://github.com/\${{ github.repository }}/releases/download/$NEW_VERSION/install.ps1 | iex"
            echo "\`\`\`"
            echo ""
            echo "### ğŸ¯ Downloads"
            echo ""
            echo "- **Windows**: Download the \`.msi\` installer or \`.exe\` files"
            echo "- **macOS**: Download the \`.dmg\` installer or \`.tar.xz\` archive"
            echo "- **Linux**: Download the \`.deb\`/\`.rpm\` packages or \`.tar.xz\` archive"
            
          } > changelog.md
          
          echo "content<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # åˆ›å»ºæ ‡ç­¾å¹¶è§¦å‘ cargo-dist å‘å¸ƒæµç¨‹
  create-tag-and-release:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # ä½¿ç”¨é»˜è®¤tokenä½†æ·»åŠ persist-credentials
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿æ­£ç¡®æ¨é€æ ‡ç­¾
          persist-credentials: true  # ä¿æŒå‡­æ®ä»¥ä¾›æ¨é€æ ‡ç­¾ä½¿ç”¨

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          NEW_VERSION="${{ needs.check-version.outputs.new_version }}"
          echo "Creating tag: $NEW_VERSION"
          
          # ç¡®ä¿æˆ‘ä»¬åœ¨æ­£ç¡®çš„åˆ†æ”¯
          git checkout main
          git pull origin main
          
          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨ï¼ˆæœ¬åœ°å’Œè¿œç¨‹ï¼‰
          if git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
            echo "Local tag $NEW_VERSION already exists, deleting it"
            git tag -d "$NEW_VERSION"
          fi
          
          if git ls-remote --tags origin | grep -q "refs/tags/$NEW_VERSION"; then
            echo "Remote tag $NEW_VERSION already exists, deleting it"
            git push origin ":refs/tags/$NEW_VERSION" || true
            sleep 5  # Wait for deletion to propagate
          fi
          
          # åˆ›å»ºæ–°æ ‡ç­¾ï¼ˆä½¿ç”¨è¯¦ç»†çš„changelogä½œä¸ºæ ‡ç­¾æ¶ˆæ¯ï¼‰
          echo "Creating annotated tag $NEW_VERSION..."
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION
          
          ${{ needs.check-version.outputs.changelog }}"
          
          # æ¨é€æ ‡ç­¾å¹¶éªŒè¯
          echo "Pushing tag $NEW_VERSION to origin..."
          if git push origin "$NEW_VERSION"; then
            echo "âœ… Tag $NEW_VERSION pushed successfully"
            
            # éªŒè¯è¿œç¨‹æ ‡ç­¾å­˜åœ¨
            sleep 3  # Wait for GitHub to process the tag
            if git ls-remote --tags origin | grep -q "refs/tags/$NEW_VERSION"; then
              echo "âœ… Tag $NEW_VERSION confirmed on remote repository"
              echo "ğŸš€ Release workflow should be triggered automatically"
              echo "Monitor progress at: https://github.com/${{ github.repository }}/actions"
            else
              echo "âš ï¸ Warning: Remote tag verification failed"
              exit 1
            fi
          else
            echo "âŒ Failed to push tag $NEW_VERSION"
            exit 1
          fi
        env:
          # ä½¿ç”¨GITHUB_TOKENä½†ç¡®ä¿æœ‰æ­£ç¡®æƒé™
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for release workflow
        run: |
          NEW_VERSION="${{ needs.check-version.outputs.new_version }}"
          echo "Tag pushed successfully. The cargo-dist release workflow should start automatically."
          echo "You can monitor the progress at: https://github.com/${{ github.repository }}/actions"
          
          # ç­‰å¾…ä¸€ä¼šå„¿å†æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
          echo "Waiting 10 seconds for tag propagation..."
          sleep 10
          
          # æ£€æŸ¥è¿œç¨‹æ ‡ç­¾
          echo "Verifying tag exists on remote..."
          if git ls-remote --tags origin | grep "refs/tags/$NEW_VERSION"; then
            echo "âœ… Tag $NEW_VERSION confirmed on remote repository"
            
            # ç­‰å¾…releaseå·¥ä½œæµå¯åŠ¨
            echo "Waiting for release workflow to start..."
            sleep 15
            
            # æ£€æŸ¥æ˜¯å¦æœ‰releaseå·¥ä½œæµæ­£åœ¨è¿è¡Œ
            echo "Checking for active release workflows..."
            echo "If no release workflow appears, check:"
            echo "1. Tag format matches release.yml triggers: 'v[0-9]+.[0-9]+.[0-9]+*'"
            echo "2. Repository permissions allow workflow triggers"
            echo "3. cargo-dist configuration in Cargo.toml"
            echo "4. You may need to manually trigger the release workflow"
          else
            echo "âš ï¸ Warning: Tag $NEW_VERSION not found on remote repository"
            echo "This might indicate a push failure or propagation delay"
          fi
          
      # å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨è§¦å‘releaseå·¥ä½œæµ
      - name: Manual trigger release workflow
        if: always()  # å§‹ç»ˆæ‰§è¡Œæ­¤æ­¥éª¤
        run: |
          NEW_VERSION="${{ needs.check-version.outputs.new_version }}"
          echo "Attempting to manually trigger release workflow for tag: $NEW_VERSION"
          
          # å°è¯•ä½¿ç”¨GitHub CLIæ‰‹åŠ¨è§¦å‘releaseå·¥ä½œæµ
          if command -v gh >/dev/null 2>&1; then
            echo "Checking if release workflow can be manually triggered..."
            # æ³¨æ„ï¼šrelease.ymléœ€è¦æ”¯æŒworkflow_dispatchæ‰èƒ½æ‰‹åŠ¨è§¦å‘
            echo "Release workflow should be triggered automatically by tag push."
            echo "If it doesn't trigger, the issue might be:"
            echo "1. GITHUB_TOKEN permissions"
            echo "2. Repository workflow settings"
            echo "3. Tag format mismatch"
          else
            echo "GitHub CLI not available for manual trigger"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}