name: Auto Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write
  actions: write
  pull-requests: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # 检查是否需要发布新版本
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.version_check.outputs.should_release }}
      new_version: ${{ steps.version_check.outputs.new_version }}
      changelog: ${{ steps.changelog.outputs.content }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史以比较版本

      - name: Get current version
        id: current_version
        run: |
          VERSION=$(grep '^version = ' crates/cliverge-gui/Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Get latest release version
        id: latest_release
        run: |
          LATEST=$(gh release list --limit 1 --json tagName --jq '.[0].tagName // "v0.0.0"' || echo "v0.0.0")
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest release: $LATEST"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if version changed
        id: version_check
        run: |
          CURRENT="v${{ steps.current_version.outputs.version }}"
          LATEST="${{ steps.latest_release.outputs.latest }}"
          
          echo "Comparing: $CURRENT vs $LATEST"
          
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "new_version=$CURRENT" >> $GITHUB_OUTPUT
            echo "Version changed, will create new release: $CURRENT"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "Version unchanged, skipping release"
          fi

      - name: Generate changelog
        id: changelog
        if: steps.version_check.outputs.should_release == 'true'
        run: |
          LATEST_TAG="${{ steps.latest_release.outputs.latest }}"
          NEW_VERSION="${{ steps.version_check.outputs.new_version }}"
          
          echo "Generating changelog from $LATEST_TAG to HEAD..."
          
          # 生成变更日志
          {
            echo "## What's Changed in $NEW_VERSION"
            echo ""
            echo "### 🚀 Features & Improvements"
            
            # 获取自上次发布以来的提交
            if [ "$LATEST_TAG" = "v0.0.0" ]; then
              # 首次发布，获取所有提交
              git log --pretty=format:"- %s (%h)" --no-merges HEAD~10..HEAD || git log --pretty=format:"- %s (%h)" --no-merges
            else
              # 获取自上次标签以来的提交
              git log --pretty=format:"- %s (%h)" --no-merges $LATEST_TAG..HEAD 2>/dev/null || {
                echo "- Initial release of CLIverge"
                echo "- Universal CLI tool management platform with GUI interface"
                echo "- Cross-platform support (Windows, macOS, Linux)"
                echo "- One-click install/uninstall for various CLI tools"
                echo "- Real-time tool status detection"
                echo "- Integrated logging system"
              }
            fi
            
            echo ""
            echo "### 📦 Installation"
            echo ""
            echo "**Shell (Linux/macOS):**"
            echo "\`\`\`bash"
            echo "curl -fsSL https://github.com/\${{ github.repository }}/releases/download/$NEW_VERSION/install.sh | sh"
            echo "\`\`\`"
            echo ""
            echo "**PowerShell (Windows):**"
            echo "\`\`\`powershell"
            echo "irm https://github.com/\${{ github.repository }}/releases/download/$NEW_VERSION/install.ps1 | iex"
            echo "\`\`\`"
            echo ""
            echo "### 🎯 Downloads"
            echo ""
            echo "- **Windows**: Download the \`.msi\` installer or \`.exe\` files"
            echo "- **macOS**: Download the \`.dmg\` installer or \`.tar.xz\` archive"
            echo "- **Linux**: Download the \`.deb\`/\`.rpm\` packages or \`.tar.xz\` archive"
            
          } > changelog.md
          
          echo "content<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # 创建标签并触发 cargo-dist 发布流程
  create-tag-and-release:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # 使用默认token但添加persist-credentials
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # 获取完整历史以便正确推送标签
          persist-credentials: true  # 保持凭据以供推送标签使用

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          NEW_VERSION="${{ needs.check-version.outputs.new_version }}"
          echo "Creating tag: $NEW_VERSION"
          
          # 确保我们在正确的分支
          git checkout main
          git pull origin main
          
          # 检查标签是否已存在（本地和远程）
          if git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
            echo "Local tag $NEW_VERSION already exists, deleting it"
            git tag -d "$NEW_VERSION"
          fi
          
          if git ls-remote --tags origin | grep -q "refs/tags/$NEW_VERSION"; then
            echo "Remote tag $NEW_VERSION already exists, deleting it"
            git push origin ":refs/tags/$NEW_VERSION" || true
            sleep 5  # Wait for deletion to propagate
          fi
          
          # 创建新标签（使用详细的changelog作为标签消息）
          echo "Creating annotated tag $NEW_VERSION..."
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION
          
          ${{ needs.check-version.outputs.changelog }}"
          
          # 推送标签并验证
          echo "Pushing tag $NEW_VERSION to origin..."
          if git push origin "$NEW_VERSION"; then
            echo "✅ Tag $NEW_VERSION pushed successfully"
            
            # 验证远程标签存在
            sleep 3  # Wait for GitHub to process the tag
            if git ls-remote --tags origin | grep -q "refs/tags/$NEW_VERSION"; then
              echo "✅ Tag $NEW_VERSION confirmed on remote repository"
              echo "🚀 Release workflow should be triggered automatically"
              echo "Monitor progress at: https://github.com/${{ github.repository }}/actions"
            else
              echo "⚠️ Warning: Remote tag verification failed"
              exit 1
            fi
          else
            echo "❌ Failed to push tag $NEW_VERSION"
            exit 1
          fi
        env:
          # 使用GITHUB_TOKEN但确保有正确权限
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for release workflow
        run: |
          NEW_VERSION="${{ needs.check-version.outputs.new_version }}"
          echo "Tag pushed successfully. The cargo-dist release workflow should start automatically."
          echo "You can monitor the progress at: https://github.com/${{ github.repository }}/actions"
          
          # 等待一会儿再检查标签是否存在
          echo "Waiting 10 seconds for tag propagation..."
          sleep 10
          
          # 检查远程标签
          echo "Verifying tag exists on remote..."
          if git ls-remote --tags origin | grep "refs/tags/$NEW_VERSION"; then
            echo "✅ Tag $NEW_VERSION confirmed on remote repository"
            
            # 等待release工作流启动
            echo "Waiting for release workflow to start..."
            sleep 15
            
            # 检查是否有release工作流正在运行
            echo "Checking for active release workflows..."
            echo "If no release workflow appears, check:"
            echo "1. Tag format matches release.yml triggers: 'v[0-9]+.[0-9]+.[0-9]+*'"
            echo "2. Repository permissions allow workflow triggers"
            echo "3. cargo-dist configuration in Cargo.toml"
            echo "4. You may need to manually trigger the release workflow"
          else
            echo "⚠️ Warning: Tag $NEW_VERSION not found on remote repository"
            echo "This might indicate a push failure or propagation delay"
          fi
          
      # 备用方案：手动触发release工作流
      - name: Manual trigger release workflow
        if: always()  # 始终执行此步骤
        run: |
          NEW_VERSION="${{ needs.check-version.outputs.new_version }}"
          echo "Attempting to manually trigger release workflow for tag: $NEW_VERSION"
          
          # 尝试使用GitHub CLI手动触发release工作流
          if command -v gh >/dev/null 2>&1; then
            echo "Checking if release workflow can be manually triggered..."
            # 注意：release.yml需要支持workflow_dispatch才能手动触发
            echo "Release workflow should be triggered automatically by tag push."
            echo "If it doesn't trigger, the issue might be:"
            echo "1. GITHUB_TOKEN permissions"
            echo "2. Repository workflow settings"
            echo "3. Tag format mismatch"
          else
            echo "GitHub CLI not available for manual trigger"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}